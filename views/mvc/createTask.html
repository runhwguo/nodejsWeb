{% extends "./myBase.html" %}

{% block main %}
<link href="//cdn.bootcss.com/bootstrap-validator/0.5.3/css/bootstrapValidator.css" rel="stylesheet">
<link rel="stylesheet" href="/static/libs/bootstrap-select-1.12.2.min.css">
<link href="//cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/Ladda/1.0.0/ladda-themeless.min.css" rel="stylesheet">
<style>

    .form-control {
        width: 70%;
        margin-left: 15%;
    }

    #publishInfo {
        margin-top: 3%;
    }

    #submit {
        width: 40%;
        margin-left: 30%;
    }

    #back {
        margin-left: 3%;
        margin-top: 2%;
    }
</style>

<input id="back" type="button" class="btn btn-link" value="< 返回"/>
<form id="publishInfo" action="/api/publish" method="post" enctype="multipart/form-data">
    <div class="form-group text-center">
        <select class="selectpicker col-form-select form-control" id="type" name="type" title="请选择发布类型">
            <option value="substituteClass">代课</option>
            <option value="substituteFetch">代取</option>
            <option value="freeRide">顺风车</option>
            <option value="borrowSomething">东西</option>
        </select>
    </div>

    <div class="form-group">
        <input type="text" class="form-control" name="name" id="name" value="{{user.name}}" placeholder="姓名">
    </div>

    <div class="form-group">
        <input type="text" class="form-control" id="tel" name="tel" value="{{user.tel}}" placeholder="电话号码">
    </div>

    <div class="form-group">
        <input type="text" id="deadline" name="deadline" class="form-control" placeholder="请选择截止时间(包含)" readonly>
    </div>

    <div class="form-group">
        <textarea class="form-control" rows="5" id="detail" cols="10" name="detail"
                  placeholder="请详细说明任务详情，比如地点时间，不然接任务人就一脸懵逼了~">三江楼405 马克思 3/4节 ffffffffffff</textarea>
    </div>
    <div class="form-group" style="margin-left: 15%">
        <input type="file" id="file" name="file" class="filestyle" data-input="false" data-buttonName="btn-primary"
               data-buttonText="图片补充(可选)">
    </div>
    <div class="form-group">
        <input type="text" class="form-control" id="reward" name="reward" value="21" placeholder="报酬(元)"/>
    </div>

    <!--<input id="login" type="submit" class="btn btn-primary" value="发布"/>-->
    <a id="submit" class="btn btn-primary ladda-button" data-style="expand-right"><span
            class="ladda-label"
            id="submitBtnWord">发布</span></a>
</form>

<script src="//cdn.bootcss.com/Ladda/1.0.0/spin.min.js"></script>
<script src="//cdn.bootcss.com/Ladda/1.0.0/ladda.min.js"></script>
<script>
  $(() => {
    let form = $("#publishInfo"),
      back = $('#back'),
      submit = $('#submit'),
      submitBtnWord = $('#submitBtnWord'),
      createTask = $('#createTaskTab');
    $('#deadline').datepicker();

    form.bootstrapValidator({
      message: 'The form is not valid',
      feedbackIcons: {
        valid: 'glyphicon glyphicon-ok',
        invalid: 'glyphicon glyphicon-remove',
        validating: 'glyphicon glyphicon-refresh'
      },
      fields: {
        name: {
          message: 'The name is not valid',
          validators: {
            notEmpty: {
              message: '姓名不能为空'
            }
          }
        },
        tel: {
          message: 'The tel is not valid',
          validators: {
            notEmpty: {
              message: '电话号码不能为空'
            },
            regexp: {
              regexp: /^(13\d|14[57]|15[^4,\D]|17[678]|18\d)\d{8}|170[059]\d{7}$/,
              message: "请输入11位有效号码"
            }
          }
        },
        detail: {
          message: 'The username is not valid',
          validators: {
            notEmpty: {
              message: '请输入任务详情'
            },
            stringLength: {
              min: 20,
              message: '请描述更详细点'
            }
          }
        },
        reward: {
          message: 'The reward is not valid',
          validators: {
            notEmpty: {
              message: '请填入相应报酬'
            },
            regexp: {
              regexp: /^[1-9]\d*$/,
              message: "请输入正整数的钱数"
            }
          }
        },
        type: {
          message: 'The type is not valid',
          validators: {
            notEmpty: {
              message: '请选择任务类型'
            }
          }
        },
        deadline: {
          message: 'The deadline is not valid',
          validators: {
            notEmpty: {
              message: '请选择结束日期'
            }
          }
        }
      }
    });
    submit.click(e => {
      e.preventDefault();
      let loading = Ladda.create(submit.get(0));
      loading.start();
      $.ajaxFileUpload({
        type: form.attr('method'),
        url: form.attr('action'),
        secureuri: false,
        fileElementId: 'file',
        data: JSON.parse('{"' + decodeURIComponent(form.serialize()).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g, '":"') + '"}'),
        dataType: 'json',
        success: (data, status) => {
          console.log(data, status);
          submitBtnWord.text('成功');
          setTimeout(() => {
            submitBtnWord.text('发布');
            loading.stop();
            $('#detail').val('');
            $('.selectpicker').selectpicker('val', []);
            $('#reward').val('');
            $(".badge").remove();
          }, 500);
        },
        error: (xhr, status, e) => {
          submitBtnWord.text('失败');
          setTimeout(() => {
            submitBtnWord.text('发布');
            loading.stop();
          }, 500);
        }
      });
    });

    back.click(() => {
      window.history.back();
    });
    createTask.attr('href', 'javascript:void(0)');
  });
</script>
<script src="//cdn.bootcss.com/bootstrap-validator/0.5.3/js/bootstrapValidator.js" defer></script>
<script src="//cdn.bootcss.com/bootstrap-filestyle/1.2.1/bootstrap-filestyle.min.js" async></script>
<script src="/static/js/ajax_file_upload.js" defer></script>
<script src="/static/libs/bootstrap-select-1.12.2.min.js" defer></script>
<script src="//cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.min.js"></script>
{% endblock %}
